<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Modal Voice Agent - Enhanced Client</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .status-bar {
            display: flex;
            justify-content: space-around;
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .status-item {
            text-align: center;
        }

        .status-label {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .status-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #495057;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .status-connected {
            background-color: #28a745;
        }

        .status-disconnected {
            background-color: #dc3545;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
        }

        .panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
        }

        .panel-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #495057;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }

        .input-group input,
        .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .input-group input:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .chat-container {
            height: 400px;
            overflow-y: auto;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 8px;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-user {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
        }

        .message-assistant {
            background: #f3e5f5;
            border-left: 4px solid #9c27b0;
        }

        .message-system {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            font-size: 0.9em;
        }

        .message-error {
            background: #ffebee;
            border-left: 4px solid #f44336;
        }

        .message-header {
            font-weight: bold;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .message-time {
            font-size: 0.8em;
            color: #6c757d;
            font-weight: normal;
        }

        .frame-log {
            height: 300px;
            overflow-y: auto;
            background: #212529;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            padding: 15px;
            border-radius: 8px;
            font-size: 0.85em;
            line-height: 1.5;
        }

        .frame-entry {
            margin-bottom: 5px;
            animation: fadeIn 0.2s;
        }

        .frame-type {
            color: #ffc107;
            font-weight: bold;
        }

        .frame-time {
            color: #17a2b8;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .metric-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .metric-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
        }

        .metric-label {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 5px;
        }

        .viz-container {
            background: white;
            border-radius: 8px;
            padding: 15px;
            min-height: 300px;
        }

        .audio-player {
            width: 100%;
            margin-top: 15px;
        }

        .tool-calls {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .tool-call-item {
            margin: 8px 0;
            padding: 8px;
            background: white;
            border-radius: 4px;
        }

        .cost-breakdown {
            background: #fff8e1;
            border-left: 4px solid #ffc107;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.9em;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .recording {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéôÔ∏è Multi-Modal Voice Agent Pipeline</h1>
            <p>Advanced Real-Time Communication System</p>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <div class="status-label">Connection</div>
                <div class="status-value">
                    <span class="status-indicator" id="connection-indicator"></span>
                    <span id="connection-status">Disconnected</span>
                </div>
            </div>
            <div class="status-item">
                <div class="status-label">Session ID</div>
                <div class="status-value" id="session-id">-</div>
            </div>
            <div class="status-item">
                <div class="status-label">Total Cost</div>
                <div class="status-value" id="total-cost">$0.000000</div>
            </div>
            <div class="status-item">
                <div class="status-label">Avg Latency</div>
                <div class="status-value" id="avg-latency">0.00s</div>
            </div>
        </div>

        <div class="main-content">
            <!-- Input Panel -->
            <div class="panel">
                <div class="panel-title">üìù Input</div>

                <div class="input-group">
                    <label>WebSocket URL</label>
                    <input type="text" id="ws-url" value="ws://localhost:8000/ws/multimodal">
                </div>

                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" id="connect-btn">Connect</button>
                    <button class="btn btn-danger" id="disconnect-btn" disabled>Disconnect</button>
                </div>

                <div class="input-group">
                    <label>Text Message</label>
                    <textarea id="text-input" rows="3" placeholder="Type your message here..."></textarea>
                </div>

                <div>
                    <button class="btn btn-primary" id="send-text-btn" disabled>Send Text</button>
                    <button class="btn btn-secondary" id="record-btn" disabled>üé§ Record Audio</button>
                </div>

                <div class="input-group" style="margin-top: 20px;">
                    <label>Quick Test Messages</label>
                    <button class="btn btn-secondary" onclick="setTestMessage('Hello, how are you?')">Greeting</button>
                    <button class="btn btn-secondary" onclick="setTestMessage('Create a bar chart with values 10, 20, 30, 40')">Chart</button>
                    <button class="btn btn-secondary" onclick="setTestMessage('Analyze sentiment: I love this product!')">Sentiment</button>
                    <button class="btn btn-secondary" onclick="setTestMessage('Get real-time usage data')">Usage Data</button>
                </div>
            </div>

            <!-- Chat Panel -->
            <div class="panel">
                <div class="panel-title">üí¨ Conversation</div>
                <div class="chat-container" id="chat-container"></div>
                <audio class="audio-player" id="audio-player" controls></audio>
            </div>

            <!-- Frame Log -->
            <div class="panel">
                <div class="panel-title">üìä Frame Log</div>
                <div class="frame-log" id="frame-log"></div>
                <button class="btn btn-secondary" onclick="clearFrameLog()" style="margin-top: 10px;">Clear Log</button>
            </div>

            <!-- Metrics Panel -->
            <div class="panel">
                <div class="panel-title">üìà Metrics</div>
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value" id="metric-turns">0</div>
                        <div class="metric-label">Total Turns</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="metric-frames">0</div>
                        <div class="metric-label">Frames Received</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="metric-tools">0</div>
                        <div class="metric-label">Tool Calls</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="metric-errors">0</div>
                        <div class="metric-label">Errors</div>
                    </div>
                </div>
            </div>

            <!-- Visualization Panel -->
            <div class="panel full-width">
                <div class="panel-title">üìä Visualization</div>
                <div class="viz-container" id="viz-container">
                    <p style="text-align: center; color: #6c757d; padding: 50px;">
                        Visualizations will appear here when generated by tool calls
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let sessionId = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let metrics = {
            turns: 0,
            frames: 0,
            tools: 0,
            errors: 0,
            latencies: [],
            totalCost: 0
        };

        // UI Elements
        const connectBtn = document.getElementById('connect-btn');
        const disconnectBtn = document.getElementById('disconnect-btn');
        const sendTextBtn = document.getElementById('send-text-btn');
        const recordBtn = document.getElementById('record-btn');
        const textInput = document.getElementById('text-input');
        const chatContainer = document.getElementById('chat-container');
        const frameLog = document.getElementById('frame-log');
        const audioPlayer = document.getElementById('audio-player');
        const wsUrlInput = document.getElementById('ws-url');

        // Event Listeners
        connectBtn.addEventListener('click', connect);
        disconnectBtn.addEventListener('click', disconnect);
        sendTextBtn.addEventListener('click', sendText);
        recordBtn.addEventListener('click', toggleRecording);
        textInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendText();
            }
        });

        function connect() {
            const url = wsUrlInput.value;
            ws = new WebSocket(url);

            ws.onopen = () => {
                updateConnectionStatus(true);
                addChatMessage('system', 'Connected to server');
            };

            ws.onmessage = async (event) => {
                if (event.data instanceof Blob) {
                    handleAudioData(event.data);
                } else {
                    const data = JSON.parse(event.data);
                    handleFrame(data);
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                addChatMessage('error', 'Connection error');
                metrics.errors++;
                updateMetrics();
            };

            ws.onclose = () => {
                updateConnectionStatus(false);
                addChatMessage('system', 'Disconnected from server');
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        function sendText() {
            const text = textInput.value.trim();
            if (!text || !ws || ws.readyState !== WebSocket.OPEN) return;

            const message = {
                type: 'user_text',
                text: text
            };

            ws.send(JSON.stringify(message));
            addChatMessage('user', text);
            textInput.value = '';
            metrics.turns++;
            updateMetrics();
        }

        async function toggleRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                recordBtn.textContent = 'üé§ Record Audio';
                recordBtn.classList.remove('recording');
            } else {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = (event) => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        await sendAudio(audioBlob);
                        stream.getTracks().forEach(track => track.stop());
                    };

                    mediaRecorder.start();
                    recordBtn.textContent = '‚èπÔ∏è Stop Recording';
                    recordBtn.classList.add('recording');
                    addChatMessage('system', 'Recording started...');
                } catch (error) {
                    console.error('Microphone access error:', error);
                    addChatMessage('error', 'Failed to access microphone');
                }
            }
        }

        async function sendAudio(audioBlob) {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;

            const metadata = {
                type: 'user_audio',
                mime_type: audioBlob.type,
                duration_sec: 0 // Could calculate from recording time
            };

            ws.send(JSON.stringify(metadata));
            ws.send(audioBlob);
            addChatMessage('user', 'üé§ Audio message sent');
            metrics.turns++;
            updateMetrics();
        }

        function handleFrame(data) {
            metrics.frames++;
            logFrame(data);

            switch(data.type) {
                case 'init':
                    sessionId = data.session_id;
                    document.getElementById('session-id').textContent = sessionId.substring(0, 8);
                    break;

                case 'ack':
                    addChatMessage('system', `Message acknowledged (${data.input_type})`);
                    break;

                case 'stt_complete':
                    addChatMessage('system', `Transcript: "${data.transcript}"`);
                    break;

                case 'llm_complete':
                    addChatMessage('assistant', data.text);
                    break;

                case 'tool_call_start':
                    displayToolCalls(data.tool_calls);
                    metrics.tools += data.tool_calls.length;
                    updateMetrics();
                    break;

                case 'tool_call_complete':
                    displayToolResults(data.results);
                    break;

                case 'visualization_data':
                    displayVisualization(data.data);
                    break;

                case 'cost_update':
                    displayCostBreakdown(data.cost_breakdown);
                    metrics.totalCost = data.session_total;
                    document.getElementById('total-cost').textContent = `$${data.session_total.toFixed(6)}`;
                    break;

                case 'metrics_update':
                    metrics.latencies.push(data.latency);
                    const avgLatency = metrics.latencies.reduce((a, b) => a + b, 0) / metrics.latencies.length;
                    document.getElementById('avg-latency').textContent = `${avgLatency.toFixed(2)}s`;
                    break;

                case 'error':
                    addChatMessage('error', data.error);
                    metrics.errors++;
                    updateMetrics();
                    break;
            }

            updateMetrics();
        }

        function handleAudioData(blob) {
            const url = URL.createObjectURL(blob);
            audioPlayer.src = url;
            addChatMessage('system', 'üîä Audio response received');
        }

        function addChatMessage(type, content) {
            const message = document.createElement('div');
            message.className = `message message-${type}`;

            const header = document.createElement('div');
            header.className = 'message-header';

            const typeLabel = document.createElement('span');
            typeLabel.textContent = type.charAt(0).toUpperCase() + type.slice(1);

            const timeLabel = document.createElement('span');
            timeLabel.className = 'message-time';
            timeLabel.textContent = new Date().toLocaleTimeString();

            header.appendChild(typeLabel);
            header.appendChild(timeLabel);

            const messageContent = document.createElement('div');
            messageContent.textContent = content;

            message.appendChild(header);
            message.appendChild(messageContent);

            chatContainer.appendChild(message);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function logFrame(data) {
            const entry = document.createElement('div');
            entry.className = 'frame-entry';

            const time = new Date().toLocaleTimeString();
            entry.innerHTML = `<span class="frame-time">[${time}]</span> <span class="frame-type">${data.type}</span> ${JSON.stringify(data).substring(0, 100)}...`;

            frameLog.appendChild(entry);
            frameLog.scrollTop = frameLog.scrollHeight;
        }

        function clearFrameLog() {
            frameLog.innerHTML = '';
        }

        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('connection-indicator');
            const status = document.getElementById('connection-status');

            if (connected) {
                indicator.className = 'status-indicator status-connected';
                status.textContent = 'Connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                sendTextBtn.disabled = false;
                recordBtn.disabled = false;
            } else {
                indicator.className = 'status-indicator status-disconnected';
                status.textContent = 'Disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                sendTextBtn.disabled = true;
                recordBtn.disabled = true;
            }
        }

        function updateMetrics() {
            document.getElementById('metric-turns').textContent = metrics.turns;
            document.getElementById('metric-frames').textContent = metrics.frames;
            document.getElementById('metric-tools').textContent = metrics.tools;
            document.getElementById('metric-errors').textContent = metrics.errors;
        }

        function displayToolCalls(toolCalls) {
            const div = document.createElement('div');
            div.className = 'tool-calls';
            div.innerHTML = '<strong>üîß Tool Calls:</strong>';

            toolCalls.forEach(tc => {
                const item = document.createElement('div');
                item.className = 'tool-call-item';
                item.innerHTML = `<strong>${tc.function}</strong><br><small>${JSON.stringify(tc.arguments)}</small>`;
                div.appendChild(item);
            });

            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function displayToolResults(results) {
            const div = document.createElement('div');
            div.className = 'tool-calls';
            div.innerHTML = '<strong>‚úÖ Tool Results:</strong>';

            results.forEach(result => {
                const item = document.createElement('div');
                item.className = 'tool-call-item';
                item.innerHTML = `<strong>${result.function}</strong><br><small>${JSON.stringify(result.result).substring(0, 200)}</small>`;
                div.appendChild(item);
            });

            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function displayCostBreakdown(cost) {
            const div = document.createElement('div');
            div.className = 'cost-breakdown';
            div.innerHTML = `
                <strong>üí∞ Cost Breakdown:</strong><br>
                LLM Input: $${cost.llm_input.toFixed(6)}<br>
                LLM Output: $${cost.llm_output.toFixed(6)}<br>
                TTS: $${cost.tts.toFixed(6)}<br>
                STT: $${cost.stt.toFixed(6)}<br>
                <strong>Total: $${cost.total.toFixed(6)}</strong>
            `;

            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function displayVisualization(data) {
            const container = document.getElementById('viz-container');

            if (data.chart_data) {
                try {
                    const chartData = JSON.parse(data.chart_data);
                    Plotly.newPlot(container, chartData.data, chartData.layout);
                } catch (error) {
                    console.error('Visualization error:', error);
                }
            } else if (data.conversation_stats) {
                const stats = data.conversation_stats;
                const trace = {
                    x: ['User', 'Assistant'],
                    y: [stats.user_words, stats.assistant_words],
                    type: 'bar',
                    marker: { color: ['#667eea', '#764ba2'] }
                };

                const layout = {
                    title: 'Word Count Comparison',
                    yaxis: { title: 'Words' }
                };

                Plotly.newPlot(container, [trace], layout);
            }
        }

        function setTestMessage(message) {
            document.getElementById('text-input').value = message;
        }
    </script>
</body>
</html>
